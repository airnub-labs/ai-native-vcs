name: AI Native VCS - Docs Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare ephemeral Docusaurus workspace
        run: |
          set -euo pipefail
          mkdir -p site/docs
          rsync -a --delete docs/ site/docs/ || true

          # Derive url/baseUrl for GitHub Pages
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          if [ "$REPO" = "${OWNER}.github.io" ]; then
            BASE="/"
          else
            BASE="/${REPO}/"
          fi
          echo "DOCUSAURUS_URL=https://${OWNER}.github.io" >> "$GITHUB_ENV"
          echo "DOCUSAURUS_BASE_URL=${BASE}" >> "$GITHUB_ENV"

          # Optional custom domain support: add a CNAME file at repo root to use it
          if [ -f CNAME ]; then
            mkdir -p site/static
            cp CNAME site/static/CNAME
          fi

          # Minimal package.json (created only in CI workspace)
          cat > site/package.json <<'JSON'
          {
            "name": "anvcs-docs-site",
            "private": true,
            "scripts": {
              "build": "docusaurus build --out-dir build"
            },
            "dependencies": {
              "@docusaurus/core": "3.9.2",
              "@docusaurus/preset-classic": "3.9.2",
              "react": "^18.2.0",
              "react-dom": "^18.2.0"
            }
          }
          JSON

          # Docusaurus config (docs-only mode, homepage at '/')
          cat > site/docusaurus.config.cjs <<'CONFIG'
          // @ts-check
          const repo = process.env.GITHUB_REPOSITORY || 'owner/repo';
          /** @type {import('@docusaurus/types').Config} */
          const config = {
            title: 'ANVCS',
            tagline: 'AI-Native Version Control',
            url: process.env.DOCUSAURUS_URL,
            baseUrl: process.env.DOCUSAURUS_BASE_URL,
            onBrokenLinks: 'throw',
            trailingSlash: false,
            organizationName: repo.split('/')[0],
            projectName: repo.split('/')[1],
            markdown: {
              hooks: {
                // Migrate from deprecated onBrokenMarkdownLinks
                onBrokenMarkdownLinks: 'warn'
              }
            },
            presets: [
              [
                'classic',
                /** @type {import('@docusaurus/preset-classic').Options} */
                ({
                  docs: {
                    path: 'docs',
                    routeBasePath: '/',
                    sidebarPath: './sidebars.cjs'
                  },
                  blog: false,
                  pages: false,
                  theme: {}
                })
              ]
            ],
            themeConfig: {
              navbar: {
                title: 'ANVCS',
                items: [
                  { href: 'https://github.com/' + repo, label: 'GitHub', position: 'right' }
                ]
              },
              footer: {
                style: 'dark',
                copyright: `Â© ${new Date().getFullYear()} ANVCS`
              }
            }
          };
          module.exports = config;
          CONFIG

          # Autogenerated sidebar
          cat > site/sidebars.cjs <<'SIDEBARS'
          // @ts-check
          /** @type {import('@docusaurus/plugin-content-docs').SidebarsConfig} */
          const sidebars = {
            docs: [{ type: 'autogenerated', dirName: '.' }]
          };
          module.exports = sidebars;
          SIDEBARS

          # Optional: patch common bad links to avoid build warnings/errors
          # Convert links like ../docs/xyz.md -> ./xyz.md within docs root
          if [ -f site/docs/README.md ]; then
            sed -i 's|(\..\/docs\/|(|g' site/docs/README.md || true
          fi
          if [ -f site/docs/archive/README.md ]; then
            sed -i 's|(\..\/addendum-|(|g' site/docs/archive/README.md || true
          fi

      - name: Install Docusaurus (ephemeral)
        working-directory: site
        run: npm install --no-audit --no-fund --no-optional

      - name: Build static site
        working-directory: site
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
